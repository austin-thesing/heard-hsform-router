(function(){let M={general:{url:"https://meetings.hubspot.com/bz/consultation",name:"Consultation Scheduler",description:"General consultation scheduling"}},k={success:"/thank-you/success",schedule:"/thank-you/schedule"},N={portalId:"7507639",formId:"233427c7-d504-46f3-9b75-9c798c25e5fc",apiEndpoint:"https://api.hsforms.com/submissions/v3/integration/submit/7507639/233427c7-d504-46f3-9b75-9c798c25e5fc",fieldName:"partial_fill_source"},y=["do_you_file_taxes_as_an_independent_contractor_or_as_the_sole_owner_of_your_business_","does_your_practice_have_multiple_owners"],_=["yes","true","y","1","multiple owners","multi"],D=["no","false","n","0"];function I(q){if(q==null)return"";return String(q).trim().toLowerCase()}function r(q){let Q=I(q);if(!Q)return!1;if(_.includes(Q))return!0;return Q.startsWith("yes")||Q.includes("multiple owners")||Q.includes("multi practice")||Q.includes("multi-owner")||Q.includes("multi owner")||Q.includes("multi-practice")}function l(q){let Q=I(q);if(!Q)return!1;if(D.includes(Q))return!0;return Q.startsWith("no")}function T(q,Q){if(!q)return null;for(let J of Q){if(q[J])return q[J];let j=[`0-1/${J}`,`0-2/${J}`,`0-3/${J}`];for(let Z of j)if(q[Z])return q[Z]}return null}let O=window.location.hostname==="localhost"||window.location.search.includes("debug=true");function X(...q){if(O)console.log("[HubSpot Router]",...q)}let B="partnerstack_click_id",K=[B,"ps_xid","psx_id"],E=["ps_xid","psx_id"];function C(q){try{if(!document.cookie)return null;let Q=document.cookie.split(";");for(let J of Q){let j=J.trim();if(!j)continue;if(j.startsWith(`${q}=`)){let[,Z]=j.split("=");if(Z)return decodeURIComponent(Z)}}}catch(Q){X(`cookie access error for ${q}:`,Q)}return null}function s(q){if(!q)return;let Q=K.flatMap((j)=>[`input[name="${j}"]`,`input[name$="/${j}"]`]);if(Q.length===0)return;let J;try{J=document.querySelectorAll(Q.join(", "))}catch(j){X("Failed to query partnerstack inputs:",j);return}if(!J||J.length===0)return;window._capturedFormData=window._capturedFormData||{},J.forEach((j)=>{if(!j||typeof j.name!=="string")return;if(!j.value)j.value=q;window._capturedFormData[j.name]=j.value;let Z=P(j.name);if(Z&&Z!==j.name)window._capturedFormData[Z]=j.value;X("Prefilled partnerstack id field:",j.name,"=",j.value)})}function S(){let q=[];for(let j of E){let Z=C(j);if(Z)q.push(Z)}try{if(window.partnerstack&&window.partnerstack.ps_xid)q.push(window.partnerstack.ps_xid)}catch(j){X("Partnerstack global lookup error:",j)}try{if(window.ps_xid)q.push(window.ps_xid)}catch(j){X("ps_xid global lookup error:",j)}try{K.forEach((j)=>{let Z=localStorage.getItem(j);if(Z)q.push(Z)})}catch(j){X("localStorage access error for partnerstack id:",j)}try{K.forEach((j)=>{let Z=sessionStorage.getItem(j);if(Z)q.push(Z)})}catch(j){X("sessionStorage access error for partnerstack id:",j)}let Q=C(B);if(Q&&!q.includes(Q))q.push(Q);return q.find((j)=>j&&j!=="undefined"&&j!=="null")||null}function g(q,Q,J){if(!q||F||U)return;try{let j=`Partial: ${Q} | ${J}`,Z=C("hubspotutk"),$={fields:[{name:"email",value:q},{name:N.fieldName,value:j}],context:{pageUri:window.location.href,pageName:document.title||"Untitled Page"}};if(Z)$.context.hutk=Z;let H=JSON.stringify($);if(navigator.sendBeacon(N.apiEndpoint,H))F=!0,X("Partial fill submitted:",{email:q,formName:Q,pageUrl:J});else X("Failed to send partial fill beacon")}catch(j){X("Error submitting partial fill:",j)}}window.HubSpotRouter=window.HubSpotRouter||{},window.HubSpotRouter.DEBUG=O;let U=!1,G=null,F=!1,V="Unknown Form";function P(q){try{if(!q)return"";let Q=String(q);return Q.indexOf("/")!==-1?Q.split("/").pop():Q}catch(Q){return q}}function c(q){let Q={};if(!q)return Q;if(Array.isArray(q))return q.forEach((J)=>{if(!J)return;let j=J.name||J.field||"",Z=P(j),$=typeof J.value==="string"?J.value:Array.isArray(J.value)?J.value[0]:J.value!=null?String(J.value):"";if(j)Q[j]=$;if(Z&&Z!==j)Q[Z]=$}),Q;if(q.fields){let J=q.fields;if(Array.isArray(J))J.forEach((j)=>{if(!j)return;let Z=j.name||j.field||"",$=P(Z),H=typeof j.value==="string"?j.value:Array.isArray(j.value)?j.value[0]:j.value!=null?String(j.value):"";if(Z)Q[Z]=H;if($&&$!==Z)Q[$]=H});else if(typeof J==="object")Object.entries(J).forEach(([j,Z])=>{let $=P(j),H=typeof Z==="string"?Z:Array.isArray(Z)?Z[0]:Z!=null?String(Z):"";if(Q[j]=H,$&&$!==j)Q[$]=H});return Q}return Object.entries(q).forEach(([J,j])=>{let Z=P(J),$=typeof j==="string"?j:Array.isArray(j)?j[0]:j!=null?String(j):"";if(Q[J]=$,Z&&Z!==J)Q[Z]=$}),Q}function L(q){return"general"}function A(q,Q){let J=M[q]||M.general,j=new URL(J.url);return j.searchParams.set("embed","true"),Object.entries({email:["email","email_address"],firstName:["firstname","first_name","fname"],lastName:["lastname","last_name","lname"],company:["company","practice_name","business_name"],phone:["phone","phone_number","telephone"]}).forEach(([H,Y])=>{for(let W of Y)if(Q[W]){j.searchParams.set(H,Q[W]),X(`Mapping ${W} -> ${H}: ${Q[W]}`);break}}),["utm_source","utm_medium","utm_campaign","utm_content","utm_term"].forEach((H)=>{if(Q[H])j.searchParams.set(H,Q[H])}),X("Built scheduler URL:",j.toString()),j.toString()}function f(q,Q){if(Q==="success"){let $=new URLSearchParams;if(q.email)$.set("email",q.email);let H=`${k.success}${$.toString()?"?"+$.toString():""}`;X("Redirecting to success page for soft rejection:",H);try{window.location.replace(H)}catch(Y){X("replace() failed, using href for success redirect",Y),window.location.href=H}return}let J={scheduler_type:Q,formData:q,timestamp:Date.now(),source:"hubspot_form"};try{sessionStorage.setItem("scheduler_router_data",JSON.stringify(J)),X("Stored router data in sessionStorage")}catch($){X("Failed to store in sessionStorage, falling back to cookies"),document.cookie=`scheduler_type=${Q}; path=/; max-age=3600`,document.cookie=`form_data=${btoa(JSON.stringify(q))}; path=/; max-age=3600`}try{localStorage.setItem("hubspot_form_data",JSON.stringify(q)),X("Stored form data in localStorage for prefill")}catch($){X("Failed to store form data in localStorage:",$)}let j=new URLSearchParams;if(q.email)j.set("email",q.email);let Z=`${k.schedule}${j.toString()?"?"+j.toString():""}`;X("Redirecting to:",Z);try{window.location.replace(Z)}catch($){X("replace() failed, using href for scheduler redirect",$),window.location.href=Z}}function h(q,Q={}){if(X("Form submission detected:",q),U){X("Routing already performed; skipping");return}U=!0;let J=S();if(J){if(!q[B])q[B]=J;try{sessionStorage.setItem(B,J)}catch(Z){X("Failed to persist partnerstack id in sessionStorage:",Z)}try{localStorage.setItem(B,J)}catch(Z){X("Failed to persist partnerstack id in localStorage:",Z)}}let j=L(q);if(f(q,j),typeof window.amplitude<"u")window.amplitude.track("scheduler_router_triggered",{scheduler_type:j,has_email:!!q.email,has_name:!!(q.firstname||q.first_name)});if(typeof window.posthog<"u")window.posthog.capture("scheduler_router_triggered",{scheduler_type:j,method:"redirect"})}function m(){window._capturedFormData=window._capturedFormData||{};let q={},Q=new WeakSet;function J($,H="change"){if(!$.name)return;let Y=$.name,W=P(Y),z=$.value,x=z;if($.type==="radio"){let w=$.closest("label");if(w&&w.textContent){let b=w.textContent.replace(/\s+/g," ").trim();if(b)x=b}}if(q[Y]===x)return;if(q[Y]=x,Y==="hs_context"||Y.startsWith("hs_")||Y==="guid")return;if(window._capturedFormData[Y]=x,W&&W!==Y)window._capturedFormData[W]=x;if($.type==="radio"){if(window._capturedFormData[`${Y}_raw`]=z,W&&W!==Y)window._capturedFormData[`${W}_raw`]=z;let w=document.querySelector(`input[type="hidden"][name="${Y}"]`);if(w&&w.value){if(window._capturedFormData[Y]=w.value,W&&W!==Y)window._capturedFormData[W]=w.value;x=w.value}}if(x){let w=$.type||$.tagName.toLowerCase();if($.type==="tel"||Y.toLowerCase().includes("phone")){let b=x.replace(/[\s\-\(\)\.]/g,"");if(b)window._capturedFormData[Y+"_clean"]=b;X("Captured phone:",Y,"=",x)}else if($.type==="radio")X("Captured radio selection:",Y,"=",x,"(raw:",z,")");else if($.type==="hidden"){if(Y==="hs_context"||Y.startsWith("hs_")||Y==="guid")return;if($.closest(".hsfc-DropdownField"))X("Captured dropdown:",Y,"=",x);else X("Captured field:",Y,"=",x)}else X("Captured",w+":",Y,"=",x)}}function j(){try{let $=document.querySelector("form[data-form-id], .hbspt-form, .hs-form");if($){let H=$.closest('[class*="form"], [id*="form"]');if(H){let W=H.querySelector("h1, h2, h3, h4");if(W&&W.textContent){let z=W.textContent.trim();if(z&&z.length<100){V=z,X("Detected form name from DOM heading:",V);return}}}let Y=$.getAttribute("data-form-id");if(Y){V=`Form ${Y}`,X("Detected form ID from DOM:",V);return}}}catch($){X("Error detecting form name from DOM:",$)}}function Z(){let $=S();if($)s($);j();let H=new MutationObserver((W)=>{let z=[];if(W.forEach((x)=>{x.addedNodes.forEach((w)=>{if(w.nodeType===1)z.push(w)})}),z.length===0)return;z.forEach((x)=>{let w=x.querySelectorAll?x.querySelectorAll("input[name], select[name], textarea[name]"):[];if(x.tagName&&(x.tagName==="INPUT"||x.tagName==="SELECT"||x.tagName==="TEXTAREA")&&x.name)Y(x);w.forEach((b)=>Y(b))})});function Y(W){if(Q.has(W))return;if(Q.add(W),W.readOnly&&W.type!=="hidden")return;let z=W.name?P(W.name):"";if((W.name===B||z===B)&&!W.value){let x=S();if(x)W.value=x,J(W,"partnerstack_prefill")}if(W.type==="hidden"&&W.name){let x=W.value,w=setInterval(()=>{if(W.value!==x)x=W.value,J(W,"programmatic");if(!document.body.contains(W))clearInterval(w)},500);if(W.value)J(W,"initial");else{let b=S();if(b&&(W.name===B||P(W.name)===B))W.value=b,J(W,"partnerstack_prefill_hidden")}}else if(W.type==="radio")W.addEventListener("change",()=>J(W));else if(W.type==="tel"||W.name&&W.name.toLowerCase().includes("phone"))W.addEventListener("blur",()=>J(W)),W.addEventListener("change",()=>J(W));else if(W.addEventListener("change",()=>J(W)),W.addEventListener("blur",()=>J(W)),W.value)J(W,"initial")}document.querySelectorAll("input[name], select[name], textarea[name]").forEach(Y),H.observe(document.body,{childList:!0,subtree:!0}),X("Form input monitoring activated")}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",Z);else Z()}function R(q){if(!q)return!1;let Q=!!T(q,y);return Boolean(q.email||q.firstname||q.first_name||q.lastname||q.last_name||q.company||q.practice_name)||Q}function d(){if(U){if(G)clearTimeout(G),G=null;return}if(!window._capturedFormData||Object.keys(window._capturedFormData).length===0){if(O)X("Multistep completion check: No form data captured yet");return}if(O)X("Multistep completion check: Checking for thank you message...",{hasFormData:!!window._capturedFormData,formDataKeys:Object.keys(window._capturedFormData).length});let q=[".submitted-message",".hs_submit_success",".hs-form-success","[data-submitted-message]",".submitted-message-content"];for(let Q of q)try{let J=document.querySelector(Q);if(J){let j=(J.textContent||J.innerText||"").toLowerCase();if(j.includes("thank")||j.includes("submitted")||j.includes("success")){if(X("Multistep form completion detected via thank you message"),console.log("[HubSpot Router] Thank you message found",{selector:Q,text:j.substring(0,100),hasRoutingData:R(window._capturedFormData)}),R(window._capturedFormData))X("Triggering redirect from multistep fallback"),console.log("[HubSpot Router] Executing redirect via fallback"),h(window._capturedFormData);else console.warn("[HubSpot Router] Thank you found but no routing data available");return}}}catch(J){}}function p(q={}){X("Initializing postMessage listener"),window.addEventListener("message",function(Q){if(!function(H){try{let Y=new URL(H).hostname;return Y.endsWith("hubspot.com")||Y.endsWith("hsforms.com")||Y.endsWith("hsforms.net")||Y.endsWith("hsappstatic.net")||Y.includes("hubspot")||Y.includes("hsforms")}catch(Y){return!1}}(Q.origin))return;let j=Q.data;if(typeof j==="string")try{j=JSON.parse(j)}catch(H){}X("Received message from HubSpot:",j);let Z=j&&(j.type||j.messageType),$=j&&j.eventName;if(j&&Z==="hsFormCallback"&&$==="onFormReady")try{if(j.data&&j.data.formName)V=j.data.formName,X("Detected form name from onFormReady:",V);else if(j.id)V=`Form ${j.id}`,X("Using form ID as name:",V)}catch(H){X("Error detecting form name:",H)}if(j&&Z==="hsFormCallback"&&($==="onFormSubmitted"||$==="onFormSubmit")){let H=j&&j.data?c(j.data):{},W={...window._capturedFormData&&typeof window._capturedFormData==="object"?window._capturedFormData:{},...H};if(!R(W)){if($==="onFormSubmit"){if(X("onFormSubmit received without routing fields; waiting for onFormSubmitted event"),!G)console.log("[HubSpot Router] Setting up multistep fallback timer"),G=setTimeout(()=>{console.log("[HubSpot Router] Starting multistep completion checks");let z=0,x=10,w=setInterval(()=>{if(z++,O||z===1||z===x)console.log(`[HubSpot Router] Multistep check ${z}/${x}`);if(d(),U||z>=x){if(clearInterval(w),G=null,z>=x)console.warn("[HubSpot Router] Multistep fallback checks completed without redirect")}},500)},1000)}else X("Submission payload lacks routing data; skipping redirect");return}if(G)clearTimeout(G),G=null;try{window._capturedFormData={...W}}catch(z){X("Failed to persist merged submission data globally:",z)}h(W,q)}else if(j&&j.formGuid&&j.accepted===!0){if(X("Developer embed submission detected"),X("Using captured form data:",window._capturedFormData),window._capturedFormData&&Object.keys(window._capturedFormData).length>0){if(G)clearTimeout(G),G=null;try{localStorage.setItem("hubspot_form_data",JSON.stringify(window._capturedFormData)),X("Stored captured form data in localStorage for prefill")}catch(H){X("Failed to store captured form data in localStorage:",H)}h(window._capturedFormData,q)}}else if(j&&Z==="hsFormCallback"&&O)X("Ignoring hsFormCallback event:",$)}),X("PostMessage listener initialized")}function u(){function q(){if(document.visibilityState==="hidden"){if(!U&&!F){let J=window._capturedFormData&&window._capturedFormData.email;if(J){let j=window.location.pathname;g(J,V,j),X("Partial fill triggered on visibility change")}}}}function Q(){if(!U&&!F){let J=window._capturedFormData&&window._capturedFormData.email;if(J){let j=window.location.pathname;g(J,V,j),X("Partial fill triggered on page hide")}}}document.addEventListener("visibilitychange",q),window.addEventListener("pagehide",Q),X("Partial fill detection initialized")}function v(q={}){let J={...{redirect:!0,debug:O},...q};if(J.debug)window.HubSpotRouterDebug={config:M,determineSchedulerType:L,buildSchedulerUrl:A,handleFormSubmission:h},X("Debug mode enabled. Access via window.HubSpotRouterDebug");m(),p(J),u(),X("HubSpot Form Router initialized with config:",J)}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>v());else v();window.HubSpotRouter={...window.HubSpotRouter,init:v,handleFormSubmission:h,determineSchedulerType:L,buildSchedulerUrl:A,config:M,DEBUG:O},X("HubSpot Form Router loaded"),console.log("[HubSpot Router] Script loaded",{debug:O,hasRouter:!!window.HubSpotRouter,url:window.location.href})})();
