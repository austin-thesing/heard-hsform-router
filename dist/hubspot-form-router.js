(function(){let C={over_100k:{url:"https://meetings.hubspot.com/bz/consultation",name:"Consultation Scheduler",description:"Revenue over $100k"},under_100k:{url:"https://meetings.hubspot.com/bz/consultations",name:"Consultations Scheduler",description:"Revenue under $100k or not provided"}},R={success:"/thank-you/success",schedule:"/thank-you/schedule"},y={portalId:"7507639",formId:"233427c7-d504-46f3-9b75-9c798c25e5fc",apiEndpoint:"https://api.hsforms.com/submissions/v3/integration/submit/7507639/233427c7-d504-46f3-9b75-9c798c25e5fc",fieldName:"partial_fill_source"},T=["annual_revenue","annual_revenue_","annual_gross_revenue","annual_income","revenue","revenue_range","gross_revenue","practice_revenue","what_is_your_annual_revenue_","what_is_your_annual_revenue","what_is_your_revenue_","what_is_your_revenue","what_is_your_practice_revenue_","what_is_your_practice_revenue"],A=["more than $100,000","more than $100000","$100,000+","$100000+"],D=["none","less than $25,000","less than $25000","$25,000 - $49,999","$25,000-$49,999","$25000 - $49999","$25000-$49999","$50,000 - $99,999","$50,000-$99,999","$50000 - $99999","$50000-$99999",...A];function F(q){if(q==null)return"";return String(q).trim().toLowerCase()}function g(q){if(q&&typeof q==="object")for(let j of Object.values(q)){let $=F(j);if(D.includes($))return j}let X=E(q,T);if(X)return X;if(!q||typeof q!=="object")return null;let J=Object.keys(q).find((j)=>{let $=F(j);return $.includes("revenue")||$.includes("income")||$.includes("gross")});return J?q[J]:null}function c(q){let X=F(q);if(!X)return!1;return A.includes(X)}function E(q,X){if(!q)return null;for(let J of X){if(q[J])return q[J];let j=[`0-1/${J}`,`0-2/${J}`,`0-3/${J}`];for(let $ of j)if(q[$])return q[$]}return null}let P=window.location.hostname==="localhost"||window.location.search.includes("debug=true");function Q(...q){if(P)console.log("[HubSpot Router]",...q)}let V="partnerstack_click_id",K=[V,"ps_xid","psx_id"],s=["ps_xid","psx_id"];function L(q){try{if(!document.cookie)return null;let X=document.cookie.split(";");for(let J of X){let j=J.trim();if(!j)continue;if(j.startsWith(`${q}=`)){let[,$]=j.split("=");if($)return decodeURIComponent($)}}}catch(X){Q(`cookie access error for ${q}:`,X)}return null}function f(q){if(!q)return;let X=K.flatMap((j)=>[`input[name="${j}"]`,`input[name$="/${j}"]`]);if(X.length===0)return;let J;try{J=document.querySelectorAll(X.join(", "))}catch(j){Q("Failed to query partnerstack inputs:",j);return}if(!J||J.length===0)return;window._capturedFormData=window._capturedFormData||{},J.forEach((j)=>{if(!j||typeof j.name!=="string")return;if(!j.value)j.value=q;window._capturedFormData[j.name]=j.value;let $=U(j.name);if($&&$!==j.name)window._capturedFormData[$]=j.value;Q("Prefilled partnerstack id field:",j.name,"=",j.value)})}function S(){let q=[];for(let j of s){let $=L(j);if($)q.push($)}try{if(window.partnerstack&&window.partnerstack.ps_xid)q.push(window.partnerstack.ps_xid)}catch(j){Q("Partnerstack global lookup error:",j)}try{if(window.ps_xid)q.push(window.ps_xid)}catch(j){Q("ps_xid global lookup error:",j)}try{K.forEach((j)=>{let $=localStorage.getItem(j);if($)q.push($)})}catch(j){Q("localStorage access error for partnerstack id:",j)}try{K.forEach((j)=>{let $=sessionStorage.getItem(j);if($)q.push($)})}catch(j){Q("sessionStorage access error for partnerstack id:",j)}let X=L(V);if(X&&!q.includes(X))q.push(X);return q.find((j)=>j&&j!=="undefined"&&j!=="null")||null}function v(q,X,J){if(!q||h||O)return;try{let j=`Partial: ${X} | ${J}`,$=L("hubspotutk"),W={fields:[{name:"email",value:q},{name:y.fieldName,value:j}],context:{pageUri:window.location.href,pageName:document.title||"Untitled Page"}};if($)W.context.hutk=$;let x=JSON.stringify(W);fetch(y.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:x,keepalive:!0}).then((Y)=>{if(Y.ok)h=!0,Q("Partial fill submitted:",{email:q,formName:X,pageUrl:J}),Q("Partial fill sent successfully:",{email:q,formName:X,pageUrl:J});else Q("Partial fill failed:",Y.status,Y.statusText)}).catch((Y)=>{Q("Partial fill error:",Y)}),h=!0}catch(j){Q("Error submitting partial fill:",j)}}window.HubSpotRouter=window.HubSpotRouter||{},window.HubSpotRouter.DEBUG=P;let O=!1,G=null,h=!1,b="Unknown Form";function U(q){try{if(!q)return"";let X=String(q);return X.indexOf("/")!==-1?X.split("/").pop():X}catch(X){return q}}function d(q){let X={};if(!q)return X;if(Array.isArray(q))return q.forEach((J)=>{if(!J)return;let j=J.name||J.field||"",$=U(j),W=typeof J.value==="string"?J.value:Array.isArray(J.value)?J.value[0]:J.value!=null?String(J.value):"";if(j)X[j]=W;if($&&$!==j)X[$]=W}),X;if(q.fields){let J=q.fields;if(Array.isArray(J))J.forEach((j)=>{if(!j)return;let $=j.name||j.field||"",W=U($),x=typeof j.value==="string"?j.value:Array.isArray(j.value)?j.value[0]:j.value!=null?String(j.value):"";if($)X[$]=x;if(W&&W!==$)X[W]=x});else if(typeof J==="object")Object.entries(J).forEach(([j,$])=>{let W=U(j),x=typeof $==="string"?$:Array.isArray($)?$[0]:$!=null?String($):"";if(X[j]=x,W&&W!==j)X[W]=x});return X}return Object.entries(q).forEach(([J,j])=>{let $=U(J),W=typeof j==="string"?j:Array.isArray(j)?j[0]:j!=null?String(j):"";if(X[J]=W,$&&$!==J)X[$]=W}),X}function k(q){let X=g(q),J=X&&c(X);return Q("Revenue routing decision",{revenueValue:X,over100k:J}),J?"over_100k":"under_100k"}function _(q,X){let J=C[q]||C.under_100k,j=new URL(J.url);return j.searchParams.set("embed","true"),Object.entries({email:["email","email_address"],firstName:["firstname","first_name","fname"],lastName:["lastname","last_name","lname"],company:["company","practice_name","business_name"],phone:["phone","phone_number","telephone"]}).forEach(([x,Y])=>{for(let Z of Y)if(X[Z]){j.searchParams.set(x,X[Z]),Q(`Mapping ${Z} -> ${x}: ${X[Z]}`);break}}),["utm_source","utm_medium","utm_campaign","utm_content","utm_term"].forEach((x)=>{if(X[x])j.searchParams.set(x,X[x])}),Q("Built scheduler URL:",j.toString()),j.toString()}function m(q,X){if(X==="success"){let W=new URLSearchParams;if(q.email)W.set("email",q.email);let x=`${R.success}${W.toString()?"?"+W.toString():""}`;Q("Redirecting to success page for soft rejection:",x);try{window.location.replace(x)}catch(Y){Q("replace() failed, using href for success redirect",Y),window.location.href=x}return}let J={scheduler_type:X,formData:q,timestamp:Date.now(),source:"hubspot_form"};try{sessionStorage.setItem("scheduler_router_data",JSON.stringify(J)),Q("Stored router data in sessionStorage")}catch(W){Q("Failed to store in sessionStorage, falling back to cookies"),document.cookie=`scheduler_type=${X}; path=/; max-age=3600`,document.cookie=`form_data=${btoa(JSON.stringify(q))}; path=/; max-age=3600`}try{localStorage.setItem("hubspot_form_data",JSON.stringify(q)),Q("Stored form data in localStorage for prefill")}catch(W){Q("Failed to store form data in localStorage:",W)}let j=new URLSearchParams;if(q.email)j.set("email",q.email);let $=`${R.schedule}${j.toString()?"?"+j.toString():""}`;Q("Redirecting to:",$);try{window.location.replace($)}catch(W){Q("replace() failed, using href for scheduler redirect",W),window.location.href=$}}function M(q,X={}){if(Q("Form submission detected:",q),O){Q("Routing already performed; skipping");return}O=!0;let J=S();if(J){if(!q[V])q[V]=J;try{sessionStorage.setItem(V,J)}catch($){Q("Failed to persist partnerstack id in sessionStorage:",$)}try{localStorage.setItem(V,J)}catch($){Q("Failed to persist partnerstack id in localStorage:",$)}}let j=k(q);if(m(q,j),typeof window.amplitude<"u")window.amplitude.track("scheduler_router_triggered",{scheduler_type:j,has_email:!!q.email,has_name:!!(q.firstname||q.first_name)});if(typeof window.posthog<"u")window.posthog.capture("scheduler_router_triggered",{scheduler_type:j,method:"redirect"})}function p(){window._capturedFormData=window._capturedFormData||{};let q={},X=new WeakSet;function J(W,x="change"){if(!W.name)return;let Y=W.name,Z=U(Y),H=W.value,z=H;if(W.type==="radio"){let w=W.closest("label");if(w&&w.textContent){let B=w.textContent.replace(/\s+/g," ").trim();if(B)z=B}}if(q[Y]===z)return;if(q[Y]=z,Y==="hs_context"||Y.startsWith("hs_")||Y==="guid")return;if(window._capturedFormData[Y]=z,Z&&Z!==Y)window._capturedFormData[Z]=z;if(W.type==="radio"){if(window._capturedFormData[`${Y}_raw`]=H,Z&&Z!==Y)window._capturedFormData[`${Z}_raw`]=H;let w=document.querySelector(`input[type="hidden"][name="${Y}"]`);if(w&&w.value){if(window._capturedFormData[Y]=w.value,Z&&Z!==Y)window._capturedFormData[Z]=w.value;z=w.value}}if(z){let w=W.type||W.tagName.toLowerCase();if(W.type==="tel"||Y.toLowerCase().includes("phone")){let B=z.replace(/[\s\-\(\)\.]/g,"");if(B)window._capturedFormData[Y+"_clean"]=B;Q("Captured phone:",Y,"=",z)}else if(W.type==="radio")Q("Captured radio selection:",Y,"=",z,"(raw:",H,")");else if(W.type==="hidden"){if(Y==="hs_context"||Y.startsWith("hs_")||Y==="guid")return;if(W.closest(".hsfc-DropdownField"))Q("Captured dropdown:",Y,"=",z);else Q("Captured field:",Y,"=",z)}else Q("Captured",w+":",Y,"=",z)}}function j(){try{let W=document.querySelector("form[data-form-id], .hbspt-form, .hs-form");if(W){let x=W.closest('[class*="form"], [id*="form"]');if(x){let Z=x.querySelector("h1, h2, h3, h4");if(Z&&Z.textContent){let H=Z.textContent.trim();if(H&&H.length<100){b=H,Q("Detected form name from DOM heading:",b);return}}}let Y=W.getAttribute("data-form-id");if(Y){b=`Form ${Y}`,Q("Detected form ID from DOM:",b);return}}}catch(W){Q("Error detecting form name from DOM:",W)}}function $(){let W=S();if(W)f(W);j();let x=new MutationObserver((Z)=>{let H=[];if(Z.forEach((z)=>{z.addedNodes.forEach((w)=>{if(w.nodeType===1)H.push(w)})}),H.length===0)return;H.forEach((z)=>{let w=z.querySelectorAll?z.querySelectorAll("input[name], select[name], textarea[name]"):[];if(z.tagName&&(z.tagName==="INPUT"||z.tagName==="SELECT"||z.tagName==="TEXTAREA")&&z.name)Y(z);w.forEach((B)=>Y(B))})});function Y(Z){if(X.has(Z))return;if(X.add(Z),Z.readOnly&&Z.type!=="hidden")return;let H=Z.name?U(Z.name):"";if((Z.name===V||H===V)&&!Z.value){let z=S();if(z)Z.value=z,J(Z,"partnerstack_prefill")}if(Z.type==="hidden"&&Z.name){let z=Z.value,w=setInterval(()=>{if(Z.value!==z)z=Z.value,J(Z,"programmatic");if(!document.body.contains(Z))clearInterval(w)},500);if(Z.value)J(Z,"initial");else{let B=S();if(B&&(Z.name===V||U(Z.name)===V))Z.value=B,J(Z,"partnerstack_prefill_hidden")}}else if(Z.type==="radio")Z.addEventListener("change",()=>J(Z));else if(Z.type==="tel"||Z.name&&Z.name.toLowerCase().includes("phone"))Z.addEventListener("blur",()=>J(Z)),Z.addEventListener("change",()=>J(Z));else if(Z.addEventListener("change",()=>J(Z)),Z.addEventListener("blur",()=>J(Z)),Z.value)J(Z,"initial")}document.querySelectorAll("input[name], select[name], textarea[name]").forEach(Y),x.observe(document.body,{childList:!0,subtree:!0}),Q("Form input monitoring activated")}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",$);else $()}function I(q){if(!q)return!1;let X=!!g(q);return Boolean(q.email||q.firstname||q.first_name||q.lastname||q.last_name||q.company||q.practice_name)||X}function u(){if(O){if(G)clearTimeout(G),G=null;return}if(!window._capturedFormData||Object.keys(window._capturedFormData).length===0){if(P)Q("Multistep completion check: No form data captured yet");return}if(P)Q("Multistep completion check: Checking for thank you message...",{hasFormData:!!window._capturedFormData,formDataKeys:Object.keys(window._capturedFormData).length});let q=[".submitted-message",".hs_submit_success",".hs-form-success","[data-submitted-message]",".submitted-message-content"];for(let X of q)try{let J=document.querySelector(X);if(J){let j=(J.textContent||J.innerText||"").toLowerCase();if(j.includes("thank")||j.includes("submitted")||j.includes("success")){if(Q("Multistep form completion detected via thank you message"),Q("Thank you message found",{selector:X,text:j.substring(0,100),hasRoutingData:I(window._capturedFormData)}),I(window._capturedFormData))Q("Triggering redirect from multistep fallback"),Q("Executing redirect via fallback"),M(window._capturedFormData);else Q("Thank you found but no routing data available");return}}}catch(J){}}function r(q={}){Q("Initializing postMessage listener"),window.addEventListener("message",function(X){if(!function(x){try{let Y=new URL(x).hostname;return Y.endsWith("hubspot.com")||Y.endsWith("hsforms.com")||Y.endsWith("hsforms.net")||Y.endsWith("hsappstatic.net")||Y.includes("hubspot")||Y.includes("hsforms")}catch(Y){return!1}}(X.origin))return;let j=X.data;if(typeof j==="string")try{j=JSON.parse(j)}catch(x){}Q("Received message from HubSpot:",j);let $=j&&(j.type||j.messageType),W=j&&j.eventName;if(j&&$==="hsFormCallback"&&W==="onFormReady")try{if(j.data&&j.data.formName)b=j.data.formName,Q("Detected form name from onFormReady:",b);else if(j.id)b=`Form ${j.id}`,Q("Using form ID as name:",b)}catch(x){Q("Error detecting form name:",x)}if(j&&$==="hsFormCallback"&&(W==="onFormSubmitted"||W==="onFormSubmit")){let x=j&&j.data?d(j.data):{},Z={...window._capturedFormData&&typeof window._capturedFormData==="object"?window._capturedFormData:{},...x};if(!I(Z)){if(W==="onFormSubmit"){if(Q("onFormSubmit received without routing fields; waiting for onFormSubmitted event"),!G)Q("Setting up multistep fallback timer"),G=setTimeout(()=>{Q("Starting multistep completion checks");let H=0,z=10,w=setInterval(()=>{if(H++,P||H===1||H===z)Q(`Multistep check ${H}/${z}`);if(u(),O||H>=z){if(clearInterval(w),G=null,H>=z)Q("Multistep fallback checks completed without redirect")}},500)},1000)}else Q("Submission payload lacks routing data; skipping redirect");return}if(G)clearTimeout(G),G=null;try{window._capturedFormData={...Z}}catch(H){Q("Failed to persist merged submission data globally:",H)}M(Z,q)}else if(j&&j.formGuid&&j.accepted===!0){if(Q("Developer embed submission detected"),Q("Using captured form data:",window._capturedFormData),window._capturedFormData&&Object.keys(window._capturedFormData).length>0){if(G)clearTimeout(G),G=null;try{localStorage.setItem("hubspot_form_data",JSON.stringify(window._capturedFormData)),Q("Stored captured form data in localStorage for prefill")}catch(x){Q("Failed to store captured form data in localStorage:",x)}M(window._capturedFormData,q)}}else if(j&&$==="hsFormCallback"&&P)Q("Ignoring hsFormCallback event:",W)}),Q("PostMessage listener initialized")}function l(){function q(){if(document.visibilityState==="hidden")if(Q("Visibility changed to hidden",{HAS_ROUTED:O,PARTIAL_FILL_SENT:h,capturedData:window._capturedFormData}),!O&&!h){let J=window._capturedFormData&&window._capturedFormData.email;if(J){let j=window.location.pathname;v(J,b,j),Q("Partial fill triggered on visibility change")}else Q("No email captured yet, skipping partial fill")}else Q("Skipping partial fill:",{reason:O?"Form already routed":"Partial fill already sent"})}function X(){if(Q("Page hide event",{HAS_ROUTED:O,PARTIAL_FILL_SENT:h,capturedData:window._capturedFormData}),!O&&!h){let J=window._capturedFormData&&window._capturedFormData.email;if(J){let j=window.location.pathname;v(J,b,j),Q("Partial fill triggered on page hide")}}}document.addEventListener("visibilitychange",q),window.addEventListener("pagehide",X),Q("Partial fill detection initialized")}function N(q={}){let J={...{redirect:!0,debug:P},...q};if(J.debug)window.HubSpotRouterDebug={config:C,determineSchedulerType:k,buildSchedulerUrl:_,handleFormSubmission:M,getCapturedData:()=>window._capturedFormData,getFormName:()=>b,testPartialFill:()=>{let j=window._capturedFormData&&window._capturedFormData.email;if(j)return v(j,b,window.location.pathname),"Partial fill submitted";return"No email captured"}},Q("Debug mode enabled. Access via window.HubSpotRouterDebug");p(),r(J),l(),Q("HubSpot Form Router initialized with config:",J)}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>N());else N();window.HubSpotRouter={...window.HubSpotRouter,init:N,handleFormSubmission:M,determineSchedulerType:k,buildSchedulerUrl:_,config:C,DEBUG:P},Q("HubSpot Form Router loaded"),Q("Script loaded",{debug:P,hasRouter:!!window.HubSpotRouter,url:window.location.href})})();
