(function(){let K={general:{url:"https://meetings.hubspot.com/bz/consultation",name:"Consultation Scheduler",description:"General consultation scheduling"}},N={success:"/thank-you/success",schedule:"/thank-you/schedule"},I={portalId:"7507639",formId:"233427c7-d504-46f3-9b75-9c798c25e5fc",apiEndpoint:"https://api.hsforms.com/submissions/v3/integration/submit/7507639/233427c7-d504-46f3-9b75-9c798c25e5fc",fieldName:"partial_fill_source"},A=["do_you_file_taxes_as_an_independent_contractor_or_as_the_sole_owner_of_your_business_","does_your_practice_have_multiple_owners"],_=["yes","true","y","1","multiple owners","multi"],D=["no","false","n","0"];function g(q){if(q==null)return"";return String(q).trim().toLowerCase()}function r(q){let Q=g(q);if(!Q)return!1;if(_.includes(Q))return!0;return Q.startsWith("yes")||Q.includes("multiple owners")||Q.includes("multi practice")||Q.includes("multi-owner")||Q.includes("multi owner")||Q.includes("multi-practice")}function l(q){let Q=g(q);if(!Q)return!1;if(D.includes(Q))return!0;return Q.startsWith("no")}function T(q,Q){if(!q)return null;for(let J of Q){if(q[J])return q[J];let j=[`0-1/${J}`,`0-2/${J}`,`0-3/${J}`];for(let X of j)if(q[X])return q[X]}return null}let P=window.location.hostname==="localhost"||window.location.search.includes("debug=true");function Z(...q){if(P)console.log("[HubSpot Router]",...q)}let V="partnerstack_click_id",S=[V,"ps_xid","psx_id"],c=["ps_xid","psx_id"];function F(q){try{if(!document.cookie)return null;let Q=document.cookie.split(";");for(let J of Q){let j=J.trim();if(!j)continue;if(j.startsWith(`${q}=`)){let[,X]=j.split("=");if(X)return decodeURIComponent(X)}}}catch(Q){Z(`cookie access error for ${q}:`,Q)}return null}function E(q){if(!q)return;let Q=S.flatMap((j)=>[`input[name="${j}"]`,`input[name$="/${j}"]`]);if(Q.length===0)return;let J;try{J=document.querySelectorAll(Q.join(", "))}catch(j){Z("Failed to query partnerstack inputs:",j);return}if(!J||J.length===0)return;window._capturedFormData=window._capturedFormData||{},J.forEach((j)=>{if(!j||typeof j.name!=="string")return;if(!j.value)j.value=q;window._capturedFormData[j.name]=j.value;let X=U(j.name);if(X&&X!==j.name)window._capturedFormData[X]=j.value;Z("Prefilled partnerstack id field:",j.name,"=",j.value)})}function C(){let q=[];for(let j of c){let X=F(j);if(X)q.push(X)}try{if(window.partnerstack&&window.partnerstack.ps_xid)q.push(window.partnerstack.ps_xid)}catch(j){Z("Partnerstack global lookup error:",j)}try{if(window.ps_xid)q.push(window.ps_xid)}catch(j){Z("ps_xid global lookup error:",j)}try{S.forEach((j)=>{let X=localStorage.getItem(j);if(X)q.push(X)})}catch(j){Z("localStorage access error for partnerstack id:",j)}try{S.forEach((j)=>{let X=sessionStorage.getItem(j);if(X)q.push(X)})}catch(j){Z("sessionStorage access error for partnerstack id:",j)}let Q=F(V);if(Q&&!q.includes(Q))q.push(Q);return q.find((j)=>j&&j!=="undefined"&&j!=="null")||null}function v(q,Q,J){if(!q||h||O)return;try{let j=`Partial: ${Q} | ${J}`,X=F("hubspotutk"),$={fields:[{name:"email",value:q},{name:I.fieldName,value:j}],context:{pageUri:window.location.href,pageName:document.title||"Untitled Page"}};if(X)$.context.hutk=X;let z=JSON.stringify($);fetch(I.apiEndpoint,{method:"POST",headers:{"Content-Type":"application/json"},body:z,keepalive:!0}).then((Y)=>{if(Y.ok)h=!0,Z("Partial fill submitted:",{email:q,formName:Q,pageUrl:J}),console.log("[HubSpot Router] Partial fill sent successfully:",{email:q,formName:Q,pageUrl:J});else console.warn("[HubSpot Router] Partial fill failed:",Y.status,Y.statusText)}).catch((Y)=>{console.error("[HubSpot Router] Partial fill error:",Y)}),h=!0}catch(j){Z("Error submitting partial fill:",j)}}window.HubSpotRouter=window.HubSpotRouter||{},window.HubSpotRouter.DEBUG=P;let O=!1,G=null,h=!1,b="Unknown Form";function U(q){try{if(!q)return"";let Q=String(q);return Q.indexOf("/")!==-1?Q.split("/").pop():Q}catch(Q){return q}}function f(q){let Q={};if(!q)return Q;if(Array.isArray(q))return q.forEach((J)=>{if(!J)return;let j=J.name||J.field||"",X=U(j),$=typeof J.value==="string"?J.value:Array.isArray(J.value)?J.value[0]:J.value!=null?String(J.value):"";if(j)Q[j]=$;if(X&&X!==j)Q[X]=$}),Q;if(q.fields){let J=q.fields;if(Array.isArray(J))J.forEach((j)=>{if(!j)return;let X=j.name||j.field||"",$=U(X),z=typeof j.value==="string"?j.value:Array.isArray(j.value)?j.value[0]:j.value!=null?String(j.value):"";if(X)Q[X]=z;if($&&$!==X)Q[$]=z});else if(typeof J==="object")Object.entries(J).forEach(([j,X])=>{let $=U(j),z=typeof X==="string"?X:Array.isArray(X)?X[0]:X!=null?String(X):"";if(Q[j]=z,$&&$!==j)Q[$]=z});return Q}return Object.entries(q).forEach(([J,j])=>{let X=U(J),$=typeof j==="string"?j:Array.isArray(j)?j[0]:j!=null?String(j):"";if(Q[J]=$,X&&X!==J)Q[X]=$}),Q}function L(q){return"general"}function y(q,Q){let J=K[q]||K.general,j=new URL(J.url);return j.searchParams.set("embed","true"),Object.entries({email:["email","email_address"],firstName:["firstname","first_name","fname"],lastName:["lastname","last_name","lname"],company:["company","practice_name","business_name"],phone:["phone","phone_number","telephone"]}).forEach(([z,Y])=>{for(let W of Y)if(Q[W]){j.searchParams.set(z,Q[W]),Z(`Mapping ${W} -> ${z}: ${Q[W]}`);break}}),["utm_source","utm_medium","utm_campaign","utm_content","utm_term"].forEach((z)=>{if(Q[z])j.searchParams.set(z,Q[z])}),Z("Built scheduler URL:",j.toString()),j.toString()}function s(q,Q){if(Q==="success"){let $=new URLSearchParams;if(q.email)$.set("email",q.email);let z=`${N.success}${$.toString()?"?"+$.toString():""}`;Z("Redirecting to success page for soft rejection:",z);try{window.location.replace(z)}catch(Y){Z("replace() failed, using href for success redirect",Y),window.location.href=z}return}let J={scheduler_type:Q,formData:q,timestamp:Date.now(),source:"hubspot_form"};try{sessionStorage.setItem("scheduler_router_data",JSON.stringify(J)),Z("Stored router data in sessionStorage")}catch($){Z("Failed to store in sessionStorage, falling back to cookies"),document.cookie=`scheduler_type=${Q}; path=/; max-age=3600`,document.cookie=`form_data=${btoa(JSON.stringify(q))}; path=/; max-age=3600`}try{localStorage.setItem("hubspot_form_data",JSON.stringify(q)),Z("Stored form data in localStorage for prefill")}catch($){Z("Failed to store form data in localStorage:",$)}let j=new URLSearchParams;if(q.email)j.set("email",q.email);let X=`${N.schedule}${j.toString()?"?"+j.toString():""}`;Z("Redirecting to:",X);try{window.location.replace(X)}catch($){Z("replace() failed, using href for scheduler redirect",$),window.location.href=X}}function M(q,Q={}){if(Z("Form submission detected:",q),O){Z("Routing already performed; skipping");return}O=!0;let J=C();if(J){if(!q[V])q[V]=J;try{sessionStorage.setItem(V,J)}catch(X){Z("Failed to persist partnerstack id in sessionStorage:",X)}try{localStorage.setItem(V,J)}catch(X){Z("Failed to persist partnerstack id in localStorage:",X)}}let j=L(q);if(s(q,j),typeof window.amplitude<"u")window.amplitude.track("scheduler_router_triggered",{scheduler_type:j,has_email:!!q.email,has_name:!!(q.firstname||q.first_name)});if(typeof window.posthog<"u")window.posthog.capture("scheduler_router_triggered",{scheduler_type:j,method:"redirect"})}function d(){window._capturedFormData=window._capturedFormData||{};let q={},Q=new WeakSet;function J($,z="change"){if(!$.name)return;let Y=$.name,W=U(Y),w=$.value,x=w;if($.type==="radio"){let H=$.closest("label");if(H&&H.textContent){let B=H.textContent.replace(/\s+/g," ").trim();if(B)x=B}}if(q[Y]===x)return;if(q[Y]=x,Y==="hs_context"||Y.startsWith("hs_")||Y==="guid")return;if(window._capturedFormData[Y]=x,W&&W!==Y)window._capturedFormData[W]=x;if($.type==="radio"){if(window._capturedFormData[`${Y}_raw`]=w,W&&W!==Y)window._capturedFormData[`${W}_raw`]=w;let H=document.querySelector(`input[type="hidden"][name="${Y}"]`);if(H&&H.value){if(window._capturedFormData[Y]=H.value,W&&W!==Y)window._capturedFormData[W]=H.value;x=H.value}}if(x){let H=$.type||$.tagName.toLowerCase();if($.type==="tel"||Y.toLowerCase().includes("phone")){let B=x.replace(/[\s\-\(\)\.]/g,"");if(B)window._capturedFormData[Y+"_clean"]=B;Z("Captured phone:",Y,"=",x)}else if($.type==="radio")Z("Captured radio selection:",Y,"=",x,"(raw:",w,")");else if($.type==="hidden"){if(Y==="hs_context"||Y.startsWith("hs_")||Y==="guid")return;if($.closest(".hsfc-DropdownField"))Z("Captured dropdown:",Y,"=",x);else Z("Captured field:",Y,"=",x)}else Z("Captured",H+":",Y,"=",x)}}function j(){try{let $=document.querySelector("form[data-form-id], .hbspt-form, .hs-form");if($){let z=$.closest('[class*="form"], [id*="form"]');if(z){let W=z.querySelector("h1, h2, h3, h4");if(W&&W.textContent){let w=W.textContent.trim();if(w&&w.length<100){b=w,Z("Detected form name from DOM heading:",b);return}}}let Y=$.getAttribute("data-form-id");if(Y){b=`Form ${Y}`,Z("Detected form ID from DOM:",b);return}}}catch($){Z("Error detecting form name from DOM:",$)}}function X(){let $=C();if($)E($);j();let z=new MutationObserver((W)=>{let w=[];if(W.forEach((x)=>{x.addedNodes.forEach((H)=>{if(H.nodeType===1)w.push(H)})}),w.length===0)return;w.forEach((x)=>{let H=x.querySelectorAll?x.querySelectorAll("input[name], select[name], textarea[name]"):[];if(x.tagName&&(x.tagName==="INPUT"||x.tagName==="SELECT"||x.tagName==="TEXTAREA")&&x.name)Y(x);H.forEach((B)=>Y(B))})});function Y(W){if(Q.has(W))return;if(Q.add(W),W.readOnly&&W.type!=="hidden")return;let w=W.name?U(W.name):"";if((W.name===V||w===V)&&!W.value){let x=C();if(x)W.value=x,J(W,"partnerstack_prefill")}if(W.type==="hidden"&&W.name){let x=W.value,H=setInterval(()=>{if(W.value!==x)x=W.value,J(W,"programmatic");if(!document.body.contains(W))clearInterval(H)},500);if(W.value)J(W,"initial");else{let B=C();if(B&&(W.name===V||U(W.name)===V))W.value=B,J(W,"partnerstack_prefill_hidden")}}else if(W.type==="radio")W.addEventListener("change",()=>J(W));else if(W.type==="tel"||W.name&&W.name.toLowerCase().includes("phone"))W.addEventListener("blur",()=>J(W)),W.addEventListener("change",()=>J(W));else if(W.addEventListener("change",()=>J(W)),W.addEventListener("blur",()=>J(W)),W.value)J(W,"initial")}document.querySelectorAll("input[name], select[name], textarea[name]").forEach(Y),z.observe(document.body,{childList:!0,subtree:!0}),Z("Form input monitoring activated")}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",X);else X()}function k(q){if(!q)return!1;let Q=!!T(q,A);return Boolean(q.email||q.firstname||q.first_name||q.lastname||q.last_name||q.company||q.practice_name)||Q}function m(){if(O){if(G)clearTimeout(G),G=null;return}if(!window._capturedFormData||Object.keys(window._capturedFormData).length===0){if(P)Z("Multistep completion check: No form data captured yet");return}if(P)Z("Multistep completion check: Checking for thank you message...",{hasFormData:!!window._capturedFormData,formDataKeys:Object.keys(window._capturedFormData).length});let q=[".submitted-message",".hs_submit_success",".hs-form-success","[data-submitted-message]",".submitted-message-content"];for(let Q of q)try{let J=document.querySelector(Q);if(J){let j=(J.textContent||J.innerText||"").toLowerCase();if(j.includes("thank")||j.includes("submitted")||j.includes("success")){if(Z("Multistep form completion detected via thank you message"),console.log("[HubSpot Router] Thank you message found",{selector:Q,text:j.substring(0,100),hasRoutingData:k(window._capturedFormData)}),k(window._capturedFormData))Z("Triggering redirect from multistep fallback"),console.log("[HubSpot Router] Executing redirect via fallback"),M(window._capturedFormData);else console.warn("[HubSpot Router] Thank you found but no routing data available");return}}}catch(J){}}function p(q={}){Z("Initializing postMessage listener"),window.addEventListener("message",function(Q){if(!function(z){try{let Y=new URL(z).hostname;return Y.endsWith("hubspot.com")||Y.endsWith("hsforms.com")||Y.endsWith("hsforms.net")||Y.endsWith("hsappstatic.net")||Y.includes("hubspot")||Y.includes("hsforms")}catch(Y){return!1}}(Q.origin))return;let j=Q.data;if(typeof j==="string")try{j=JSON.parse(j)}catch(z){}Z("Received message from HubSpot:",j);let X=j&&(j.type||j.messageType),$=j&&j.eventName;if(j&&X==="hsFormCallback"&&$==="onFormReady")try{if(j.data&&j.data.formName)b=j.data.formName,Z("Detected form name from onFormReady:",b);else if(j.id)b=`Form ${j.id}`,Z("Using form ID as name:",b)}catch(z){Z("Error detecting form name:",z)}if(j&&X==="hsFormCallback"&&($==="onFormSubmitted"||$==="onFormSubmit")){let z=j&&j.data?f(j.data):{},W={...window._capturedFormData&&typeof window._capturedFormData==="object"?window._capturedFormData:{},...z};if(!k(W)){if($==="onFormSubmit"){if(Z("onFormSubmit received without routing fields; waiting for onFormSubmitted event"),!G)console.log("[HubSpot Router] Setting up multistep fallback timer"),G=setTimeout(()=>{console.log("[HubSpot Router] Starting multistep completion checks");let w=0,x=10,H=setInterval(()=>{if(w++,P||w===1||w===x)console.log(`[HubSpot Router] Multistep check ${w}/${x}`);if(m(),O||w>=x){if(clearInterval(H),G=null,w>=x)console.warn("[HubSpot Router] Multistep fallback checks completed without redirect")}},500)},1000)}else Z("Submission payload lacks routing data; skipping redirect");return}if(G)clearTimeout(G),G=null;try{window._capturedFormData={...W}}catch(w){Z("Failed to persist merged submission data globally:",w)}M(W,q)}else if(j&&j.formGuid&&j.accepted===!0){if(Z("Developer embed submission detected"),Z("Using captured form data:",window._capturedFormData),window._capturedFormData&&Object.keys(window._capturedFormData).length>0){if(G)clearTimeout(G),G=null;try{localStorage.setItem("hubspot_form_data",JSON.stringify(window._capturedFormData)),Z("Stored captured form data in localStorage for prefill")}catch(z){Z("Failed to store captured form data in localStorage:",z)}M(window._capturedFormData,q)}}else if(j&&X==="hsFormCallback"&&P)Z("Ignoring hsFormCallback event:",$)}),Z("PostMessage listener initialized")}function u(){function q(){if(document.visibilityState==="hidden")if(console.log("[HubSpot Router] Visibility changed to hidden",{HAS_ROUTED:O,PARTIAL_FILL_SENT:h,capturedData:window._capturedFormData}),!O&&!h){let J=window._capturedFormData&&window._capturedFormData.email;if(J){let j=window.location.pathname;v(J,b,j),Z("Partial fill triggered on visibility change")}else console.log("[HubSpot Router] No email captured yet, skipping partial fill")}else console.log("[HubSpot Router] Skipping partial fill:",{reason:O?"Form already routed":"Partial fill already sent"})}function Q(){if(console.log("[HubSpot Router] Page hide event",{HAS_ROUTED:O,PARTIAL_FILL_SENT:h,capturedData:window._capturedFormData}),!O&&!h){let J=window._capturedFormData&&window._capturedFormData.email;if(J){let j=window.location.pathname;v(J,b,j),Z("Partial fill triggered on page hide")}}}document.addEventListener("visibilitychange",q),window.addEventListener("pagehide",Q),Z("Partial fill detection initialized"),console.log("[HubSpot Router] Partial fill detection initialized")}function R(q={}){let J={...{redirect:!0,debug:P},...q};if(J.debug)window.HubSpotRouterDebug={config:K,determineSchedulerType:L,buildSchedulerUrl:y,handleFormSubmission:M,getCapturedData:()=>window._capturedFormData,getFormName:()=>b,testPartialFill:()=>{let j=window._capturedFormData&&window._capturedFormData.email;if(j)return v(j,b,window.location.pathname),"Partial fill submitted";return"No email captured"}},Z("Debug mode enabled. Access via window.HubSpotRouterDebug");d(),p(J),u(),Z("HubSpot Form Router initialized with config:",J)}if(document.readyState==="loading")document.addEventListener("DOMContentLoaded",()=>R());else R();window.HubSpotRouter={...window.HubSpotRouter,init:R,handleFormSubmission:M,determineSchedulerType:L,buildSchedulerUrl:y,config:K,DEBUG:P},Z("HubSpot Form Router loaded"),console.log("[HubSpot Router] Script loaded",{debug:P,hasRouter:!!window.HubSpotRouter,url:window.location.href})})();
